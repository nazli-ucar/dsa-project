import pandas as pd
from io import StringIO

# --- Load Weather Data ---
with open("raw data weather text.txt", "r", encoding="utf-8") as f:
    weather_text = f.read()

weather_df = pd.read_csv(StringIO(weather_text))

# Clean weather data
weather_df['Date'] = pd.to_datetime(weather_df['datetime']).dt.date
weather_clean = weather_df[['Date', 'temp', 'humidity', 'windgust']].rename(
    columns={
        'temp': 'Temperature',
        'humidity': 'Humidity',
        'windgust': 'Windgust'
    }
)

# --- Load Traffic Data ---
traffic_df = pd.read_csv("traffic_announcement.csv", delimiter=';')
traffic_df['ANNOUNCEMENT_STARTING_DATETIME'] = pd.to_datetime(
    traffic_df['ANNOUNCEMENT_STARTING_DATETIME'], errors='coerce'
)
traffic_df['Date'] = traffic_df['ANNOUNCEMENT_STARTING_DATETIME'].dt.date

# Count accidents per day
accident_counts = traffic_df.groupby('Date').size().reset_index(name='Accident Count')

# --- Merge datasets ---
final_df = pd.merge(accident_counts, weather_clean, on='Date', how='inner')
final_df = final_df[['Date', 'Accident Count', 'Temperature', 'Windgust', 'Humidity']]

# --- Print the result ---
# Show all rows
print(final_df.to_string(index=False))
final_df.to_excel("final_numeric_weather_accidents.xlsx", index=False)
